#!/usr/bin/env php
<?php

foreach ([ __DIR__ . '/../../autoload.php', __DIR__ . '/../vendor/autoload.php', __DIR__ . '/vendor/autoload.php' ] as $file) {
	if (file_exists($file) === true) {
		require($file);
		break;
	}
}

$cwd = getcwd();
// Config this bad boy.
if(file_exists($cwd.'/.runway-config.json') === false) {
	return require __DIR__.'/scripts/setup.php';
}

$config = json_decode(file_get_contents($cwd.'/.runway-config.json'), true);

$consoleApp = new Ahc\Cli\Application('runway', '1.0.1');

$cwd = getcwd();

$rootPaths = [ 
	$cwd, 
	__DIR__ 
];

if(isset($config['root_paths'])) {
	$rootPaths = array_merge($rootPaths, $config['root_paths']);
}

$basePaths = [
	'/vendor/flightphp', // to capture flightphp projects
	'/vendor/flightphp-**', // to capture flightphp projects with hyphens
	'/**', // capture random packages
	'/**/**', // capture more randomness
	'/**/**/**', // this is getting fun now
	'', // to capture commands in the root of the project
];

if(isset($config['base_paths'])) {
	$basePaths = array_merge($basePaths, $config['base_paths']);
}

$finalPaths = [
	'/src/commands/*.php',
	'/flight/commands/*.php',
	'/commands/*.php',
];

// Add the app root if you decided to configure it
if(isset($config['app_root']) === true) {
	$finalPaths[] = '/'.$config['app_root'].'commands/*.php';
}

if(isset($config['final_paths'])) {
	$finalPaths = array_merge($finalPaths, $config['final_paths']);
}

// Now that we've figured out all the possible paths, let's do this!
foreach($rootPaths as $rootPath) {
	foreach($basePaths as $basePath) {
		foreach($finalPaths as $finalPath) {
			$paths[] = $rootPath.$basePath.$finalPath;
		}
	}
}

$addedCommands = [];
foreach($paths as $path) {
	foreach(glob($path) as $commandPath) {

		// Must extend the AbstractBaseCommand class
		if(basename($commandPath) === 'AbstractBaseCommand.php') {
			continue;
		}
		$command = str_replace('.php', '', basename($commandPath));
		
		// namespace needs to be flight\commands
		$command = 'flight\\commands\\'.$command;

		// To prevent duplicates from being loaded
		if(in_array($command, $addedCommands, true) === true) {
			continue;
		}
		// Keep track of the commands added
		$addedCommands[] = $command;
		
		require $commandPath;
		$consoleApp->add(new $command($config));
	}
}

$argv = (array) $_SERVER['argv'];

$consoleApp->handle($argv);
